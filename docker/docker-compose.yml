# MCP Docker Infrastructure
# Version: 2.0.0
# Enhanced with additional services, health checks, and resource limits

services:
  # ============================================
  # MCP Gateway - Central router for all MCP servers
  # ============================================
  mcp-gateway:
    build:
      context: ./mcp-gateway
      dockerfile: Dockerfile
      args:
        VERSION: ${MCP_VERSION:-2.0.0}
        BUILD_DATE: ${BUILD_DATE:-}
    container_name: mcp-gateway
    hostname: mcp-gateway
    ports:
      - "9000:8000"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-60}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-30}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - CIRCUIT_BREAKER_THRESHOLD=${CIRCUIT_BREAKER_THRESHOLD:-5}
      - CIRCUIT_BREAKER_TIMEOUT=${CIRCUIT_BREAKER_TIMEOUT:-60}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - CACHE_TTL=${CACHE_TTL:-300}
      # Service URLs
      - MCP_FILESYSTEM_URL=http://mcp-filesystem:8000
      - MCP_WEBSEARCH_URL=http://mcp-websearch:8000
      - MCP_GITHUB_URL=http://mcp-github:8000
      - MCP_PYTHON_URL=http://mcp-python:8000
      - MCP_DATABASE_URL=http://mcp-database:8000
      - MCP_MEMORY_URL=http://mcp-memory:8000
    depends_on:
      mcp-filesystem:
        condition: service_healthy
      mcp-websearch:
        condition: service_healthy
      mcp-github:
        condition: service_healthy
      mcp-python:
        condition: service_healthy
      mcp-database:
        condition: service_healthy
      mcp-memory:
        condition: service_healthy
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      - "com.mcp.service=gateway"
      - "com.mcp.version=${MCP_VERSION:-2.0.0}"

  # ============================================
  # MCP Server: Filesystem Operations
  # ============================================
  mcp-filesystem:
    build:
      context: ./mcp-servers/filesystem
      dockerfile: Dockerfile
    container_name: mcp-filesystem
    hostname: mcp-filesystem
    volumes:
      - ./shared-workspace:/workspace:rw
    environment:
      - WORKSPACE_DIR=/workspace
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=filesystem"

  # ============================================
  # MCP Server: Web Search (via SearXNG)
  # ============================================
  mcp-websearch:
    build:
      context: ./mcp-servers/web-search
      dockerfile: Dockerfile
    container_name: mcp-websearch
    hostname: mcp-websearch
    environment:
      - MAX_RESULTS=${SEARCH_MAX_RESULTS:-10}
      - TIMEOUT=${SEARCH_TIMEOUT:-30}
      - SEARXNG_URL=http://searxng:8080
    depends_on:
      searxng:
        condition: service_healthy
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=websearch"

  # ============================================
  # SearXNG - Meta Search Engine (aggregates 70+ engines)
  # ============================================
  searxng:
    image: docker.io/searxng/searxng:latest
    container_name: searxng
    hostname: searxng
    volumes:
      - ./mcp-servers/searxng:/etc/searxng:z
    environment:
      - SEARXNG_BASE_URL=http://searxng:8080/
      - SEARXNG_SECRET=${SEARXNG_SECRET:-ultrasecretkey123changeme}
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=searxng"

  # ============================================
  # MCP Server: GitHub Operations
  # ============================================
  mcp-github:
    build:
      context: ./mcp-servers/github
      dockerfile: Dockerfile
    container_name: mcp-github
    hostname: mcp-github
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=github"

  # ============================================
  # MCP Server: Python Code Execution
  # ============================================
  mcp-python:
    build:
      context: ./mcp-servers/python-exec
      dockerfile: Dockerfile
    container_name: mcp-python
    hostname: mcp-python
    environment:
      - MAX_EXECUTION_TIME=${MAX_EXECUTION_TIME:-30}
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-256}
      - MAX_OUTPUT_SIZE=${MAX_OUTPUT_SIZE:-65536}
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "com.mcp.service=python"

  # ============================================
  # MCP Server: Database Operations (SQLite)
  # ============================================
  mcp-database:
    build:
      context: ./mcp-servers/database
      dockerfile: Dockerfile
    container_name: mcp-database
    hostname: mcp-database
    volumes:
      - ./data:/data:rw
    environment:
      - DB_DIR=/data
      - MAX_RESULTS=${DB_MAX_RESULTS:-1000}
      - ALLOW_WRITE_OPS=${ALLOW_WRITE_OPS:-true}
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=database"

  # ============================================
  # MCP Server: In-Memory Key-Value Store
  # ============================================
  mcp-memory:
    build:
      context: ./mcp-servers/memory
      dockerfile: Dockerfile
    container_name: mcp-memory
    hostname: mcp-memory
    environment:
      - DEFAULT_TTL=${DEFAULT_TTL:-3600}
      - MAX_KEYS_PER_NAMESPACE=${MAX_KEYS_PER_NAMESPACE:-10000}
      - MAX_VALUE_SIZE=${MAX_VALUE_SIZE:-1048576}
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 512M
    labels:
      - "com.mcp.service=memory"

  # ============================================
  # Observability Stack (Optional - use: docker compose --profile observability up)
  # ============================================
  
  # Prometheus - Metrics collection
  prometheus:
    profiles: ["observability"]
    image: prom/prometheus:v2.48.0
    container_name: prometheus
    hostname: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro,z
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "com.mcp.service=prometheus"

  # Loki - Log aggregation
  loki:
    profiles: ["observability"]
    image: grafana/loki:2.9.3
    container_name: loki
    hostname: loki
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./observability/loki/loki-config.yml:/etc/loki/loki-config.yml:ro,z
      - loki-data:/loki
    ports:
      - "3100:3100"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "com.mcp.service=loki"

  # Promtail - Log collector
  promtail:
    profiles: ["observability"]
    image: grafana/promtail:2.9.3
    container_name: promtail
    hostname: promtail
    command: -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ./observability/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro,z
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - mcp-network
    depends_on:
      - loki
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=promtail"

  # Grafana - Dashboards & visualization
  grafana:
    profiles: ["observability"]
    image: grafana/grafana:10.2.3
    container_name: grafana
    hostname: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-magentic123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro,z
      - ./observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro,z
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro,z
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - mcp-network
    depends_on:
      - prometheus
      - loki
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    labels:
      - "com.mcp.service=grafana"

  # cAdvisor - Container metrics
  cadvisor:
    profiles: ["observability"]
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: cadvisor
    hostname: cadvisor
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8080:8080"
    networks:
      - mcp-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.mcp.service=cadvisor"

# ============================================
# Networks
# ============================================
networks:
  mcp-network:
    driver: bridge
    name: mcp-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================
# Volumes
# ============================================
volumes:
  shared-workspace:
    driver: local
  mcp-data:
    driver: local
  prometheus-data:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local
